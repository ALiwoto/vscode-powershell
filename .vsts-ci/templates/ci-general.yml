steps:
  - pwsh: '$PSVersionTable'
  displayName: PowerShell version

  - pwsh: Write-Host "##vso[build.updatebuildnumber]$env:BUILD_SOURCEBRANCHNAME-$env:BUILD_SOURCEVERSION-$((get-date).ToString("yyyyMMddhhmmss"))"
    displayName: Set Build Name for Non-PR
    condition: ne(variables['Build.Reason'], 'PullRequest')

    # TODO: Use a submodule or some such so we can actually track a version here.
  - pwsh: |
      git clone https://github.com/PowerShell/PowerShellEditorServices.git ../PowerShellEditorServices
      Install-Module InvokeBuild -Scope CurrentUser -Force
      Install-Module PlatyPS -Scope CurrentUser -Force
      New-Item -ItemType Directory $(Build.ArtifactStagingDirectory)/vscode-powershell

  # Build
  - pwsh: Invoke-Build

  - task: PublishTestResults@2
  displayName: Publish test results
    inputs:
      testRunner: JUnit
      testResultsFiles: '**/test-results.xml'
    condition: succeededOrFailed()

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: vscode-powershell
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/vscode-powershell'

  # Rich Navigation
  - task: RichCodeNavIndexer@0
    # Note, for now, this is Windows only.
    condition: and(succeededOrFailed(), eq(variables['Agent.OS'], 'Windows_NT'))
    continueOnError: true
    inputs:
      serviceConnection: 'rich-nav'
      nugetServiceConnection: 'rich-nav-nuget'
      githubServiceConnection: 'PowerShell'
      languages: 'typescript,csharp'
      serviceEndpoint: 'https://prod.richnav.vsengsaas.visualstudio.com'
